!function(b,a){if("function"==typeof define&&define.amd){define(["module","exports","angular","ws"],a)}else{if("undefined"!=typeof exports){a(module,exports,require("angular"),require("ws"))}else{var c={exports:{}};a(c,c.exports,b.angular,b.ws),b.angularWebsocket=c.exports}}}(this,function(L,v,B,D){function w(a){return a&&a.__esModule?a:{"default":a}}function z(c,a,d,f){function b(e,g,h){h||!G(g)||x(g)||(h=g,g=void 0),this.protocols=g,this.url=e||"Missing URL",this.ssl=/(wss)/i.test(this.url),this.scope=h&&h.scope||c,this.rootScopeFailover=h&&h.rootScopeFailover&&!0,this.useApplyAsync=h&&h.useApplyAsync||!1,this.initialTimeout=h&&h.initialTimeout||500,this.maxTimeout=h&&h.maxTimeout||300000,this.reconnectIfNotNormalClose=h&&h.reconnectIfNotNormalClose||!1,this.binaryType=h&&h.binaryType||"blob",this._reconnectAttempts=0,this.sendQueue=[],this.onOpenCallbacks=[],this.onMessageCallbacks=[],this.onErrorCallbacks=[],this.onCloseCallbacks=[],K(this._readyStateConstants),e?this._connect():this._setInternalState(0)}return b.prototype._readyStateConstants={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3,RECONNECT_ABORTED:4},b.prototype._normalCloseCode=1000,b.prototype._reconnectableStatusCodes=[4000],b.prototype.safeDigest=function(g){g&&!this.scope.$$phase&&this.scope.$digest()},b.prototype.bindToScope=function(e){var g=this;return e&&(this.scope=e,this.rootScopeFailover&&this.scope.$on("$destroy",function(){g.scope=c})),g},b.prototype._connect=function(g){!g&&this.socket&&this.socket.readyState===this._readyStateConstants.OPEN||(this.socket=f.create(this.url,this.protocols),this.socket.onmessage=N["default"].bind(this,this._onMessageHandler),this.socket.onopen=N["default"].bind(this,this._onOpenHandler),this.socket.onerror=N["default"].bind(this,this._onErrorHandler),this.socket.onclose=N["default"].bind(this,this._onCloseHandler),this.socket.binaryType=this.binaryType)},b.prototype.fireQueue=function(){for(;this.sendQueue.length&&this.socket.readyState===this._readyStateConstants.OPEN;){var g=this.sendQueue.shift();this.socket.send(M(g.message)||"blob"!=this.binaryType?g.message:JSON.stringify(g.message)),g.deferred.resolve()}},b.prototype.notifyOpenCallbacks=function(h){for(var g=0;g<this.onOpenCallbacks.length;g++){this.onOpenCallbacks[g].call(this,h)}},b.prototype.notifyCloseCallbacks=function(h){for(var g=0;g<this.onCloseCallbacks.length;g++){this.onCloseCallbacks[g].call(this,h)}},b.prototype.notifyErrorCallbacks=function(h){for(var g=0;g<this.onErrorCallbacks.length;g++){this.onErrorCallbacks[g].call(this,h)}},b.prototype.onOpen=function(g){return this.onOpenCallbacks.push(g),this},b.prototype.onClose=function(g){return this.onCloseCallbacks.push(g),this},b.prototype.onError=function(g){return this.onErrorCallbacks.push(g),this},b.prototype.onMessage=function(h,g){if(!j(h)){throw new Error("Callback must be a function")}if(g&&O(g.filter)&&!M(g.filter)&&!(g.filter instanceof RegExp)){throw new Error("Pattern must be a string or regular expression")}return this.onMessageCallbacks.push({fn:h,pattern:g?g.filter:void 0,autoApply:g?g.autoApply:!0}),this},b.prototype._onOpenHandler=function(g){this._reconnectAttempts=0,this.notifyOpenCallbacks(g),this.fireQueue()},b.prototype._onCloseHandler=function(h){var g=this;g.useApplyAsync?g.scope.$applyAsync(function(){g.notifyCloseCallbacks(h)}):(g.notifyCloseCallbacks(h),g.safeDigest(!0)),(this.reconnectIfNotNormalClose&&h.code!==this._normalCloseCode||this._reconnectableStatusCodes.indexOf(h.code)>-1)&&this.reconnect()},b.prototype._onErrorHandler=function(h){var g=this;g.useApplyAsync?g.scope.$applyAsync(function(){g.notifyErrorCallbacks(h)}):(g.notifyErrorCallbacks(h),g.safeDigest(!0))},b.prototype._onMessageHandler=function(k){function g(p,n,r){r=E.call(arguments,2),h.useApplyAsync?h.scope.$applyAsync(function(){p.apply(h,r)}):(p.apply(h,r),h.safeDigest(n))}for(var l,m,h=this,i=0;i<h.onMessageCallbacks.length;i++){m=h.onMessageCallbacks[i],l=m.pattern,l?M(l)&&k.data===l?g(m.fn,m.autoApply,k):l instanceof RegExp&&l.exec(k.data)&&g(m.fn,m.autoApply,k):g(m.fn,m.autoApply,k)}},b.prototype.close=function(g){return !g&&this.socket.bufferedAmount||this.socket.close(),this},b.prototype.send=function(m){function n(o){o.cancel=k;var i=o.then;return o.then=function(){var p=i.apply(this,arguments);return n(p)},o}function k(e){return h.sendQueue.splice(h.sendQueue.indexOf(m),1),l.reject(e),h}var l=a.defer(),h=this,g=n(l.promise);return h.readyState===h._readyStateConstants.RECONNECT_ABORTED?l.reject("Socket connection has been closed"):(h.sendQueue.push({message:m,deferred:l}),h.fireQueue()),f.isMocked&&f.isMocked()&&f.isConnected(this.url)&&this._onMessageHandler(f.mockSend()),g},b.prototype.reconnect=function(){this.close();var h=this._getBackoffDelay(++this._reconnectAttempts),g=h/1000;return console.log("Reconnecting in "+g+" seconds"),d(N["default"].bind(this,this._connect),h),this},b.prototype._getBackoffDelay=function(k){var g=Math.random()+1,l=this.initialTimeout,m=2,h=k,i=this.maxTimeout;return Math.floor(Math.min(g*l*Math.pow(m,h),i))},b.prototype._setInternalState=function(g){if(Math.floor(g)!==g||0>g||g>4){throw new Error("state must be an integer between 0 and 4, got: "+g)}I||(this.readyState=g||this.socket.readyState),this._internalConnectionState=g,J(this.sendQueue,function(h){h.deferred.reject("Message cancelled due to closed socket connection")})},I&&I(b.prototype,"readyState",{get:function(){return this._internalConnectionState||this.socket.readyState},set:function(){throw new Error("The readyState property is read-only")}}),function(h,g,i){return new b(h,g,i)}}function H(a){this.create=function(c,b){var d=/wss?:\/\//.exec(c);if(!d){throw new Error("Invalid url provided")}return b?new P(c,b):new P(c)},this.createWebSocketBackend=function(b,c){return a.warn("Deprecated: Please use .create(url, protocols)"),this.create(b,c)}}Object.defineProperty(v,"__esModule",{value:!0});var P,N=w(B),F="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a};if("object"===("undefined"==typeof v?"undefined":F(v))&&"function"==typeof require){try{P=D.Client||D.client||D}catch(q){}}P=P||window.WebSocket||window.MozWebSocket;var A=N["default"].noop,K=Object.freeze?Object.freeze:A,I=Object.defineProperty,M=N["default"].isString,j=N["default"].isFunction,O=N["default"].isDefined,G=N["default"].isObject,x=N["default"].isArray,J=N["default"].forEach,E=Array.prototype.slice;Array.prototype.indexOf||(Array.prototype.indexOf=function(b){var a=this.length>>>0,c=Number(arguments[1])||0;for(c=0>c?Math.ceil(c):Math.floor(c),0>c&&(c+=a);a>c;c++){if(c in this&&this[c]===b){return c}}return -1}),N["default"].module("ngWebSocket",[]).factory("$websocket",["$rootScope","$q","$timeout","$websocketBackend",z]).factory("WebSocket",["$rootScope","$q","$timeout","WebsocketBackend",z]).service("$websocketBackend",["$log",H]).service("WebSocketBackend",["$log",H]),N["default"].module("angular-websocket",["ngWebSocket"]),v["default"]=N["default"].module("ngWebSocket"),L.exports=v["default"]});